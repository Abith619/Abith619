!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("XPhone",[],t):"object"==typeof exports?exports.XPhone=t():e.XPhone=t()}(this,function(){return function(e){function t(i){if(n[i])return n[i].exports;var s=n[i]={i:i,l:!1,exports:{}};return e[i].call(s.exports,s,s.exports,t),s.l=!0,s.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,i){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),r=n(1),a=i(r),c=n(3),l=i(c),u=n(4),h=function(){function e(){s(this,e),this.id=Math.random().toString(36).substring(7),this.socket=null,this.lastMessageDuration=0,this.timer=null,this.calls=new a.default(this),this.media=new l.default,this.REMOTE=1,this.EXPECTED_CLOSE=!0,this.credentials=u.authTemplate,this.REGISTER_DELAY=5e3,this.registerTimeout=this.REGISTER_DELAY,this.INCOMING=0,this.OUTGOING=1,this.wsURL="wss://lira.voip.com.ua:1887",this.mainWsURL=this.wsURL,this.callOut="",this.player=document.createElement("AUDIO"),this.player.setAttribute("autoplay","autoplay"),this.player.setAttribute("id",this.id),this.reConnect=!0,this.isExpectedClose=!1}return o(e,[{key:"init",value:function(e){var t=this,n=e;n.phone_number=void 0!==e.phone_number||""===e.phone_number?e.phone_number:e.login,this.credentials=n,this.socket=new WebSocket(this.wsURL),this.socket.onopen=function(){t.send({connect:n})},this.socket.onclose=function(e){t.isExpectedClose||(t.wsURL=t.mainWsURL),t.onClose(e),t.isExpectedClose=!1,t.stopTimer(),t.autoInit()},this.socket.onerror=function(e){t.onError({message:e})},this.socket.onmessage=function(e){t.onMessage(e)},this.media.gotRemoteStream=function(e){t.player&&(t.player.srcObject=e.stream)},this.media.onCreate=function(e){t.send(e)},this.media.onError=function(e){t.onError({message:e})},document.getElementById(this.id)||document.body.appendChild(this.player)}},{key:"close",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;e&&(this.registerTimeout=t),this.isExpectedClose=e,this.socket&&this.socket.close(),this.media.disableUserMedia()}},{key:"autoInit",value:function(){var e=this;!this.isOpen()&&this.reConnect&&setTimeout(function(){e.init(e.credentials),e.registerTimeout*=2},this.registerTimeout)}},{key:"send",value:function(e){return this.isOpen()&&this.socket.send(JSON.stringify(e)),0}},{key:"sendInfo",value:function(e,t){return this.send({info:e,msg_values:{line:t}}),0}},{key:"isOpen",value:function(){return void 0!==this.socket&&null!==this.socket&&this.socket.readyState===WebSocket.OPEN}},{key:"onOpen",value:function(){return this}},{key:"onClose",value:function(){return this}},{key:"onError",value:function(){return this}},{key:"onCreate",value:function(){return this}},{key:"onChange",value:function(){return this}},{key:"onConnect",value:function(){return this}},{key:"onDestroy",value:function(){return this}},{key:"makeCall",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.OUTGOING,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(!this.isOpen())throw this.onError({message:"Connection failed"}),new Error("Connection failed");var i=this.calls.add(e,t,n);return t===this.OUTGOING&&this.calls.findForwardCall()&&this.forwardCall(i),i}},{key:"finishCall",value:function(e){var t=this.calls.findByLine(e);return this.calls.remove(t),t}},{key:"acceptCall",value:function(e){return this.calls.findByLine(e).accept()}},{key:"sendDTMF",value:function(e,t){return this.send({info:"sendDTMF",msg_values:{line:""+t+e}}),!0}},{key:"holdCall",value:function(e){return this.calls.findByLine(e).toggleHold()}},{key:"conferenceCall",value:function(e){return this.calls.findByLine(e).toggleConference()}},{key:"forwardCall",value:function(e){var t=this.calls.findForwardCall(),n=this.calls.findByLine(e),i=n.toggleForward();return i&&t&&(this.send({info:"forward",msg_values:{line:t.line+"_"+n.line}}),this.calls.remove(t),this.calls.remove(n)),i}},{key:"getCalls",value:function(){return this.calls.get()}},{key:"doTimer",value:function(){var e=this;this.timer=setInterval(function(){e.lastMessageDuration+=1,e.lastMessageDuration>=25&&e.close(!e.EXPECTED_CLOSE)},1e3)}},{key:"startTimer",value:function(){this.doTimer()}},{key:"stopTimer",value:function(){clearInterval(this.timer)}},{key:"onMessage",value:function(e){var t=this,n=JSON.parse(e.data)||u.msgTemplate,i=n.msg_type,s=n.msg_values;if(this.lastMessageDuration=0,!Object.prototype.hasOwnProperty.call(s,"line")||this.calls.lineExist(s.line))switch(i){case"route":this.registerTimeout=this.REGISTER_DELAY,this.startTimer(),this.onOpen();break;case"ping":this.send({pong:"pong"});break;case"invited":var o=s.ani_num,r=this.makeCall(o,this.INCOMING,s.id);this.callOut&&setTimeout(function(){t.createMessage("accepted",{line:r})},4e3);break;case"callme":this.callOut?this.send({callout:this.callOut}):this.media.createUserMedia();break;case"byed":this.finishCall(s.line,this.REMOTE);break;case"accepted":this.acceptCall(s.line);break;case"volume_on":0===Number(s.voice)&&(this.media.disableUserMedia(),this.send({webrtc:"close"}));break;case"sdp":this.media.setRemoteSdp(s);break;case"webrtc_restart":this.media.disableUserMedia(),this.media.createUserMedia();break;case"url_rec":this.calls.findByLine(s.line).set("file",s.url);break;case"reconnect":this.wsURL=s.url,this.close()}}},{key:"createMessage",value:function(e,t){var n={data:JSON.stringify({msg_type:e,msg_values:t})};this.onMessage(n)}}]),e}();t.default=h},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),o=n(2),r=function(e){return e&&e.__esModule?e:{default:e}}(o),a=function(){function e(t){i(this,e),this.stack=t,this.data=[]}return s(e,[{key:"findByLine",value:function(e){for(var t=0;t<this.data.length;t+=1)if(this.data[t].line===Number(e))return this.data[t];throw new Error("Line not found")}},{key:"lineExist",value:function(e){for(var t=0;t<this.data.length;t+=1)if(this.data[t].line===Number(e))return!0;return!1}},{key:"findForwardCall",value:function(){for(var e=0;e<this.data.length;e+=1)if(this.data[e].forward)return this.data[e];return null}},{key:"get",value:function(){return this.data}},{key:"add",value:function(e,t,n,i){var s=new r.default(this.stack,e,t,n,i);return this.data.push(s),this.stack.onCreate(s),s.line}},{key:"remove",value:function(e){e.finish(),this.data.splice(this.data.indexOf(e),1),this.stack.onDestroy(e)}}]),e}();t.default=a},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),r=function(){function e(t,n,s,o){i(this,e),this.stack=t,this.phoneNumber=n,this.type=s,this.id=o||null,e.line+=1,this.line=e.line,this.startDate=new Date,this.connectDate=null,this.hold=!1,this.conference=!1,this.forward=!1,this.file="#",this.init()}return o(e,[{key:"init",value:function(){switch(this.type){case 1:this.stack.send({invite:"sip:"+this.phoneNumber+"@"+this.line});break;case 0:this.stack.send({ringing:{id:this.id,line:""+this.line}})}}},{key:"set",value:function(e,t){var n=this;if("string"==typeof e&&this.setProp(e,t)&&this.stack.onChange(this),"object"===(void 0===e?"undefined":s(e))){var i=0;Object.getOwnPropertyNames(e).forEach(function(t){n.setProp(t,e[t])&&(i+=1)}),i&&this.stack.onChange(this)}}},{key:"setProp",value:function(e,t){var n=!1;return void 0!==this[e]&&this[e]!==t&&(this[e]=t,"connectDate"===e&&this.stack.onConnect(this),n=!0),n}},{key:"finish",value:function(){return this.stack.sendInfo("bye",this.line),!0}},{key:"accept",value:function(){return this.set("connectDate",new Date),this.stack.send({accept:{line:this.line}}),!0}},{key:"toggleHold",value:function(){return this.set("hold",!this.hold),this.stack.sendInfo(this.hold?"on_hold":"off_hold",this.line),this.hold}},{key:"toggleConference",value:function(){return this.set("conference",!this.conference),this.stack.sendInfo(this.conference?"on_conference":"off_conference",this.line),this.conference}},{key:"toggleForward",value:function(){return this.set("forward",!this.forward),this.forward}}]),e}();t.default=r,r.line=0},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),o=function(){function e(){i(this,e),this.localMediaStream=null,this.PeerConnection=window.RTCPeerConnection,this.SessionDescription=window.RTCSessionDescription,this.pc=null,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia}return s(e,[{key:"gotRemoteStream",value:function(){return this}},{key:"onError",value:function(){return this}},{key:"onCreate",value:function(){return this}},{key:"createUserMedia",value:function(){var e=this;navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(t){e.localMediaStream=t,e.createOffer()}).catch(function(t){e.onError(t)})}},{key:"disableUserMedia",value:function(){this.localMediaStream&&this.localMediaStream.getTracks()[0].stop(),this.pc&&"closed"!==this.pc.iceConnectionState&&this.pc.close()}},{key:"setRemoteSdp",value:function(e){this.pc&&"function"==typeof this.pc.setRemoteDescription&&this.pc.setRemoteDescription(new this.SessionDescription(e))}},{key:"createOffer",value:function(){var e=this;this.pc=new this.PeerConnection(null),this.pc.addStream(this.localMediaStream),this.pc.onaddstream=this.gotRemoteStream,this.pc.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!1}).then(function(t){e.pc.setLocalDescription(t),e.onCreate(t)}).catch(function(t){e.onError({message:t})})}}]),e}();t.default=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.msgTemplate={msg_type:"",msg_value:{line:"",ani_num:"",voice:"",url:""}},t.authTemplate={login:"",phone_number:"",password:""}}]).default});
